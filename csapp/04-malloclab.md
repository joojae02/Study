# malloclab

## 동적 메모리 할당

- 힙이라 불리는 가상메모리 영역을 다룸
- 힙의 꼭대기를 가르키는 변수를 brk (break)
- 다양한 크기의 블럭들의 집합으로 관리됨

### 명시적 할당기
- 명시적 할당기는 응용이 명시적으로 할당된 블록을 반환해줄 것을 요구
- C 표준 라이브러리는 malloc 패키지를 제공
- C 프로그램은 malloc 함수를 호줄해서 블록을 할당, free 함수를 호출해서 블록 반환
  
### 묵시적 할당기

- 언제 할당된 블록이 더 이상 프로그램에 의해 사용되지 않고 블록을 반환하는지를 할당기가 검출할 수 있을 것을 요구
- 묵시적 할당기는 가비지 컬렉터(garbage collector)라고 알려져 있으며, 자동으로 사용하지 않은 할당된 블록을 반환시켜주는 작업을 가비지 컬렉션이라고 부름
- List, ML, 자바 같은 상위 수준 언어들이 가비지 컬렉션 사용

## malloc, free

c 표준 라이브러리는 malloc 패키지로 알려진 명시적 할당기를 제공한다.   
- 데이터 객체에 대해서 적절히 정렬된 최조 size 바이트를 갖는 메모리 블럭의 포인터 리턴
- 32 비트 모드에선 항상 8의 배수인 블럭 리턴
- 64 비트 모드에선 16의 배수 리턴

sbrk 함수
- 커널의 brk 포인터에 incr을 더해서 힙을 늘리거나 줄임
- 성공하면 brk 값 리턴
- 실패하면 -1 리턴

free 함수
- 할당된 블럭을 해제함

<img src = "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdHxinI%2FbtreRRW9JHo%2FnZWwSisrFI6DEPRwRngkg0%2Fimg.png" >

## 단편화

나쁜 힙 이용도의 주요 이유   
이는 가용메모리가 할당 요청을 만족시키기에는 가용하지 않았을 때 일어난다.   
다시 말해 메모리 할당 요청을 만족시킬 수 없을 때 일어난다.

### 내부단편화
- 할당된 블록이 데이터 자체보다 더 클 때 일어남

### 외부단편화
-  할당 요청을 만족시키기기 위한 가용 메모리가 충분하지만, 정렬 문제로 메모리에 할당하지 못 하는 경우 발생


## 구현

단순한 할당기   
- 첫번쨰 바이트를 가르키는 포인터 p
- size 바이트를 할당하기 위해 p 값을 스택에 저장후 size만큼 증가
- p의 이전값 리턴

문제점
- 사용한 블럭들을 재사용하지 않음
  

고려해야 할점
- 가용 블럭 구성 : 어떻게 가용 블럭들을 추적할것인가
- 배치: 새롭게 할당된 블록을 배치하기 위한 가용 블록을 어떻게 선택하는가?
- 분할: 새롭게 할당한 블록을 가용 블록에 배치한 후 가용 블록의 나머지 부분들로 무어을 할 것인가?
- 연결: 방금 반환된 블록으로 무엇을 할 것인가?

<img src = "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbOaDNo%2FbtreYnUMcpd%2FTVkd3zjW5rLD5ltiNBOksk%2Fimg.png" >

### 묵시적
- implicit 방법은 할당된 블록과 가용한 블록이 모두 연결되어 있음
### 명시적
- ecplicit 방법은 가용 가능한 블록끼리만 연결되어 있음

## 할당한 블록의 배치
### first fit
- 처음부터 검색해서 크기가 맞는 첫 번째 가용 블록을 선택
- 앞부분에 작은 크기 뒷부분에 큰크기의 블럭이 모이게 되어 사용할수록 느려짐
### next fit
- 이전 검색이 종료된 지점에서 검색해서 크기가 맞는 첫 번째 가용 블록을 선택
- first fit 의 대안 
- 하지만 first fit보다 메모리 이용도가 안좋을 수 있음
### best fit
- 모든 가용블록을 검사하여 크기가 맞는 가장 작은 블록을 선택

## 가용 블럭의 분할
- 가용 블럭 전체를 사용하게 되면 내부 단편화가 일어날수 있음
- 가용 블럭을 분할하여 사용

## 추가적인 힙 메모리 획득하기

- 충분히 큰 블럭이 만들어지지 않거나 최대로 연결되었다면 sbrk함수 호출해서 추가 메모리 요청
- 할당기는 추가 메모리를 큰 가용 블럭으로 배치 후 사용

## 가용 블럭 연결하기

- 새롭게 반환하는 블럭에 인접한 가용 블럭이 있으면 오류 단편화 발생
- 이를 극복하기 위해서는 연결이라는 과정으로 인접한 가용 블록들을 통합해야 함


## 경계 태그로 연결

- footer 사용
